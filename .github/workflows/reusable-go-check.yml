name: Reusable Go Quality Workflow

on:
  workflow_call:
    inputs:
      go-version:
        required: false
        type: string
        default: stable
      run-tests:
        required: false
        type: boolean
        default: true
      run-lint:
        required: false
        type: boolean
        default: true
      run-vulncheck:
        required: false
        type: boolean
        default: true
      golangci-lint-version:
        required: false
        type: string
        default: latest
      test-flags:
        required: false
        type: string
        default: ""
      test-timeout:
        required: false
        type: string
        default: "10m"
      coverage-threshold:
        required: false
        type: number
        default: 0
      test-parallelism:
        required: false
        type: number
        default: 1
      fail-on-vulncheck:
        required: false
        type: boolean
        default: true
      skip-format-check:
        required: false
        type: boolean
        default: false
      timeout-minutes:
        required: false
        type: number
        default: 30
      use-container:
        required: false
        type: boolean
        default: true
        description: 'Use Mjolnir container for builds (provides pre-installed Go toolchain and tools)'
      container-image:
        required: false
        type: string
        default: 'ghcr.io/inovacc/mjolnir:latest-alpine'
        description: 'Container image to use when use-container is true'
    outputs:
      coverage-percent:
        description: "Test coverage percentage"
        value: ${{ jobs.quality-check.outputs.coverage }}
      tests-passed:
        description: "Whether all tests passed"
        value: ${{ jobs.quality-check.outputs.tests-passed }}
      lint-passed:
        description: "Whether linting passed"
        value: ${{ jobs.quality-check.outputs.lint-passed }}
      vulncheck-passed:
        description: "Whether vulnerability check passed"
        value: ${{ jobs.quality-check.outputs.vulncheck-passed }}

jobs:
  quality-check:
    runs-on: ubuntu-latest
    container: ${{ inputs.use-container && inputs.container-image || '' }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
      tests-passed: ${{ steps.test-result.outputs.passed }}
      lint-passed: ${{ steps.lint-result.outputs.passed }}
      vulncheck-passed: ${{ steps.vulncheck-result.outputs.passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go (host mode)
        if: ${{ !inputs.use-container }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run golangci-lint (container mode)
        id: golangci-lint-container
        if: ${{ inputs.run-lint == true && inputs.use-container }}
        run: golangci-lint run ./...
        continue-on-error: true

      - name: Run golangci-lint (host mode)
        id: golangci-lint-host
        if: ${{ inputs.run-lint == true && !inputs.use-container }}
        uses: golangci/golangci-lint-action@v9
        with:
          version: ${{ inputs.golangci-lint-version }}
        continue-on-error: true

      - name: Check Go format
        id: gofmt
        if: ${{ inputs.run-lint == true && inputs.skip-format-check == false }}
        run: |
          fmt_out=$(gofmt -l .)
          if [ -n "$fmt_out" ]; then
            echo "Files not properly formatted:"
            echo "$fmt_out"
            exit 1
          fi
        continue-on-error: true

      - name: Set lint result
        id: lint-result
        if: ${{ inputs.run-lint == true }}
        run: |
          LINT_OUTCOME="${{ inputs.use-container && steps.golangci-lint-container.outcome || steps.golangci-lint-host.outcome }}"
          if [ "$LINT_OUTCOME" == "failure" ] || [ "${{ steps.gofmt.outcome }}" == "failure" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Cache govulncheck (host mode)
        if: ${{ inputs.run-vulncheck == true && !inputs.use-container }}
        uses: actions/cache@v4
        with:
          path: ~/go/bin/govulncheck
          key: govulncheck-${{ runner.os }}

      - name: Install govulncheck (host mode)
        if: ${{ inputs.run-vulncheck == true && !inputs.use-container }}
        run: |
          if [ ! -f ~/go/bin/govulncheck ]; then
            go install golang.org/x/vuln/cmd/govulncheck@latest
          fi

      - name: Run vulncheck
        id: vulncheck
        if: ${{ inputs.run-vulncheck == true }}
        run: govulncheck -show verbose ./...
        continue-on-error: ${{ !inputs.fail-on-vulncheck }}

      - name: Set vulncheck result
        id: vulncheck-result
        if: ${{ inputs.run-vulncheck == true }}
        run: |
          if [ "${{ steps.vulncheck.outcome }}" == "failure" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            if [ "${{ inputs.fail-on-vulncheck }}" == "true" ]; then
              exit 1
            fi
          else
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Download Go modules
        if: ${{ inputs.run-tests == true }}
        run: go mod download

      - name: Run tests with coverage
        id: test
        if: ${{ inputs.run-tests == true }}
        run: |
          go test -race -p=${{ inputs.test-parallelism }} -timeout=${{ inputs.test-timeout }} -coverprofile=coverage.out ${{ inputs.test-flags }} ./...
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html
        continue-on-error: true

      - name: Extract coverage percentage
        if: ${{ inputs.run-tests == true && steps.test.outcome != 'failure' }}
        id: coverage
        run: |
          percent=$(go tool cover -func=coverage.out | grep total: | awk '{print substr($3, 1, length($3)-1)}')
          echo "coverage=$percent" >> $GITHUB_OUTPUT
          echo "## Coverage report" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY

          # Check coverage threshold
          if (( $(echo "$percent < ${{ inputs.coverage-threshold }}" | bc -l) )); then
            echo "::error::Coverage $percent% is below threshold ${{ inputs.coverage-threshold }}%"
            exit 1
          fi

      - name: Set test result
        id: test-result
        if: ${{ inputs.run-tests == true }}
        run: |
          if [ "${{ steps.test.outcome }}" == "failure" ]; then
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage report
        if: ${{ inputs.run-tests == true }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.*

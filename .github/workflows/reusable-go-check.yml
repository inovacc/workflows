name: Reusable Go Quality Workflow

on:
  workflow_call:
    inputs:
      go-version:
        required: false
        type: string
        default: stable
      run-tests:
        required: false
        type: boolean
        default: true
      run-lint:
        required: false
        type: boolean
        default: true
      run-vulncheck:
        required: false
        type: boolean
        default: true

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Run golangci-lint
        if: ${{ inputs.run-lint == true }}
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0

      - name: Check Go format
        if: ${{ inputs.run-lint == true }}
        run: |
          fmt_out=$(gofmt -l .)
          if [ -n "$fmt_out" ]; then
            echo "Files not properly formatted:"
            echo "$fmt_out"
            exit 1
          fi
      - name: Run vulncheck
        if: ${{ inputs.run-vulncheck == true }}
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -show verbose ./...

      - name: Download Go modules
        if: ${{ inputs.run-tests == true }}
        run: go mod download

      - name: Run tests with coverage
        if: ${{ inputs.run-tests == true }}
        run: |
          go test -race -p=1 -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
          go tool cover -html=coverage.out -o coverage.html

      - name: Extract coverage percentage
        if: ${{ inputs.run-tests == true }}
        id: coverage
        run: |
          percent=$(go tool cover -func=coverage.out | grep total: | awk '{print substr($3, 1, length($3)-1)}')
          echo "coverage=$percent" >> $GITHUB_OUTPUT
          echo "## Coverage report" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage report
        if: ${{ inputs.run-tests == true }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.*
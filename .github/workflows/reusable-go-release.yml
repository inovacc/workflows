# .github/workflows/reusable-go-release.yml
name: Release Binary Builder

on:
  workflow_call:
    inputs:
      go-version:
        required: false
        type: string
        default: stable
      run-release:
        required: false
        type: boolean
        default: true
      library-mode:
        required: false
        type: boolean
        default: false
        description: 'Library mode: create a GitHub release with notes instead of building binaries with GoReleaser'
      goreleaser-version:
        required: false
        type: string
        default: latest
      goreleaser-args:
        required: false
        type: string
        default: release --clean
      skip-validate:
        required: false
        type: boolean
        default: false
      draft:
        required: false
        type: boolean
        default: false
      timeout-minutes:
        required: false
        type: number
        default: 30
      use-container:
        required: false
        type: boolean
        default: true
        description: 'Use Mjolnir container for builds (provides pre-installed Go toolchain and GoReleaser)'
      container-image:
        required: false
        type: string
        default: 'ghcr.io/inovacc/mjolnir:latest-alpine'
        description: 'Container image to use when use-container is true'
    outputs:
      release-url:
        description: "URL to the created release"
        value: ${{ jobs.release.outputs.release-url }}
      release-tag:
        description: "Tag name of the release"
        value: ${{ jobs.release.outputs.release-tag }}
      release-created:
        description: "Whether release was successfully created"
        value: ${{ jobs.release.outputs.release-created }}

permissions:
  contents: write

jobs:
  release:
    name: Build and Release Binary
    runs-on: ubuntu-latest
    container: ${{ inputs.use-container && inputs.container-image || '' }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    if: ${{ inputs.run-release == true }}
    outputs:
      release-url: ${{ steps.release-info.outputs.url }}
      release-tag: ${{ steps.release-info.outputs.tag }}
      release-created: ${{ steps.goreleaser-container.outcome == 'success' || steps.goreleaser-host.outcome == 'success' || steps.library-release.outcome == 'success' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git safe directory (container mode)
        if: ${{ inputs.use-container }}
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Set up Go (host mode)
        if: ${{ !inputs.use-container }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: Extract tag info
        id: tag-info
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" =~ ^refs/tags/(.+)$ ]]; then
            TAG="${BASH_REMATCH[1]}"
            echo "tag=${TAG}" >> $GITHUB_OUTPUT
            echo "::notice::Building release for tag ${TAG}"
          else
            echo "::error::Not a tag push, cannot create release"
            exit 1
          fi

      - name: Validate .goreleaser.yaml
        if: ${{ inputs.skip-validate == false && inputs.library-mode == false }}
        run: |
          if [ ! -f .goreleaser.yaml ] && [ ! -f .goreleaser.yml ]; then
            echo "::error::.goreleaser.yaml or .goreleaser.yml not found"
            exit 1
          fi
          echo "::notice::GoReleaser config found"

      - name: Tidy Go modules
        run: go mod tidy

      - name: Install GitHub CLI (container mode)
        if: ${{ inputs.library-mode == true && inputs.use-container }}
        run: |
          if ! command -v gh &> /dev/null; then
            apk add --no-cache github-cli 2>/dev/null || \
            (curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
             echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
             apt-get update && apt-get install -y gh) 2>/dev/null || \
            (GH_VERSION=$(curl -s https://api.github.com/repos/cli/cli/releases/latest | grep tag_name | cut -d '"' -f4 | sed 's/v//') && \
             curl -fsSL "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz" | tar xz -C /tmp && \
             cp /tmp/gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/)
          fi
          gh --version

      - name: Create library release
        id: library-release
        if: ${{ inputs.library-mode == true && startsWith(github.ref, 'refs/tags/') }}
        run: |
          TAG="${{ steps.tag-info.outputs.tag }}"
          DRAFT_FLAG=""
          if [ "${{ inputs.draft }}" == "true" ]; then
            DRAFT_FLAG="--draft"
          fi
          gh release create "$TAG" \
            --title "$TAG" \
            --generate-notes \
            $DRAFT_FLAG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser (container mode)
        id: goreleaser-container
        if: ${{ inputs.library-mode == false && startsWith(github.ref, 'refs/tags/') && inputs.use-container }}
        run: goreleaser ${{ inputs.goreleaser-args }} ${{ inputs.draft && '--draft' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser (host mode)
        id: goreleaser-host
        if: ${{ inputs.library-mode == false && startsWith(github.ref, 'refs/tags/') && !inputs.use-container }}
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: ${{ inputs.goreleaser-version }}
          args: ${{ inputs.goreleaser-args }} ${{ inputs.draft && '--draft' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set release info
        id: release-info
        if: ${{ steps.goreleaser-container.outcome == 'success' || steps.goreleaser-host.outcome == 'success' || steps.library-release.outcome == 'success' }}
        run: |
          TAG="${{ steps.tag-info.outputs.tag }}"
          REPO="${{ github.repository }}"
          URL="https://github.com/${REPO}/releases/tag/${TAG}"
          echo "url=${URL}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "::notice::Release created at ${URL}"
